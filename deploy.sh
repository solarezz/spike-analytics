#!/bin/bash
# ะกะบัะธะฟั ะดะตะฟะปะพั Spike Analytics ะฝะฐ ัะตัะฒะตั

echo "๐ ะะตะฟะปะพะน Spike Analytics..."

# ะะตัะตัะพะดะธะผ ะฒ ะดะพะผะฐัะฝัั ะดะธัะตะบัะพัะธั
cd /home/mark

# ะะปะพะฝะธััะตะผ ัะตะฟะพะทะธัะพัะธะน (ะตัะปะธ ะตัะต ะฝะต ะบะปะพะฝะธัะพะฒะฐะปะธ)
if [ ! -d "spike-analytics" ]; then
    echo "๐ฅ ะะปะพะฝะธัะพะฒะฐะฝะธะต ัะตะฟะพะทะธัะพัะธั..."
    git clone https://github.com/solarezz/spike-analytics.git
else
    echo "๐ฅ ะะฑะฝะพะฒะปะตะฝะธะต ัะตะฟะพะทะธัะพัะธั..."
    cd spike-analytics
    git pull origin main
    cd ..
fi

# ะะตัะตัะพะดะธะผ ะฒ ะดะธัะตะบัะพัะธั ะฟัะพะตะบัะฐ
cd spike-analytics

# ะกะพะทะดะฐะตะผ .env ัะฐะนะป ะตัะปะธ ะตะณะพ ะฝะตั
if [ ! -f ".env" ]; then
    echo "๐ ะกะพะทะดะฐะฝะธะต .env ัะฐะนะปะฐ..."
    cp .env.example .env
    echo "โ ะะะะะ: ะััะตะดะฐะบัะธััะนัะต ัะฐะนะป .env ะธ ะดะพะฑะฐะฒััะต ะฒะฐั TG_TOKEN!"
    echo "nano .env"
    exit 1
fi

# ะัะพะฒะตััะตะผ ะฟัะฐะฒะฐ ะดะพัััะฟะฐ ะบ Docker
if ! docker ps &>/dev/null; then
    echo "โ ะัะถะฝั ะฟัะฐะฒะฐ ะฐะดะผะธะฝะธัััะฐัะพัะฐ ะดะปั Docker..."
    echo "๐ง ะะพะฑะฐะฒะปัะตะผ ะฟะพะปัะทะพะฒะฐัะตะปั ะฒ ะณััะฟะฟั docker..."
    sudo usermod -aG docker $USER
    echo "๐ ะะตัะตะทะฐะณััะถะฐะตะผ ะณััะฟะฟั..."
    newgrp docker
    echo "โ ะัะฐะฒะฐ ะฝะฐัััะพะตะฝั!"
fi

# ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะบะพะฝัะตะนะฝะตัั
echo "๐ ะััะฐะฝะพะฒะบะฐ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ..."
sudo docker-compose down 2>/dev/null || true

# ะะตัะตัะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ
echo "๐จ ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ..."
sudo docker-compose up --build -d

# ะะพะบะฐะทัะฒะฐะตะผ ััะฐััั
echo "๐ ะกัะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ:"
sudo docker-compose ps

echo "๐ ะะพัะผะพััะตัั ะปะพะณะธ: sudo docker-compose logs -f"
echo "๐ ะััะฐะฝะพะฒะธัั: sudo docker-compose down"
echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"
